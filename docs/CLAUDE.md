# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Ashida Attendance** is a React Native mobile application built with Expo that connects to a Frappe/ERPNext backend for attendance tracking, leave management, and employee reports. The app uses token-based authentication (API key/secret) with a custom mobile login endpoint.

## Development Commands

### Running the App
```bash
npm start              # Start Expo development server
npm run android        # Run on Android device/emulator
npm run ios           # Run on iOS device/simulator
npm run web           # Run in web browser
```

### EAS Build (Expo Application Services)
The project is configured with EAS for production builds:
```bash
eas build --profile development    # Development build
eas build --profile preview        # Preview build (internal distribution)
eas build --profile production     # Production build (auto-increment version)
```

## Architecture

### App Structure

The app follows a **token-based authentication architecture** with a clear separation between authenticated and unauthenticated flows:

1. **Entry Point** (`App.js`):
   - Wraps the app with UI Kitten's ApplicationProvider (using Eva dark theme)
   - Provides SafeAreaProvider for safe area handling
   - Wraps navigation with AuthProvider for global authentication state

2. **Navigation** (`src/navigation/AppNavigator.js`):
   - Uses conditional rendering based on authentication status
   - **Unauthenticated**: Shows only LoginScreen
   - **Authenticated**: Shows HomeScreen with bottom tabs and nested screens (LeaveApplication, Holidays, ReportsScreen, MonthlyAttendanceSheet)

3. **Home Screen Structure** (`src/screens/HomeScreen.js`):
   - Contains a shared Navbar component
   - Bottom tab navigator with three tabs:
     - HomeTab: Main attendance tracking
     - UpdatesTab: Notifications and updates
     - ProfileTab: User profile and settings

### Authentication Flow (CRITICAL)

**This app uses TOKEN-BASED authentication with API key/secret, NOT session-based authentication.**

- **AuthContext** (`app/contexts/AuthContext.js`):
  - All API calls use `Authorization: token {api_key}:{api_secret}` header
  - NO session cookies are used
  - API key and secret are stored securely in SecureStore
  - Login flow with ESS validation and device binding:
    1. POST to `/api/method/ashida.ashida_gaxis.api.mobile_auth.mobile_app_login` with username and **app password** (not regular Frappe password)
    2. Backend validates:
       - User exists
       - Employee record exists with matching `user_id`
       - **`allow_ess` field is enabled (value = 1)** in Employee doctype
       - **App password matches** the one set in Employee record
       - **Device ID check**: First login registers unique device ID, subsequent logins must match
    3. If all checks pass, backend returns:
       - `employee_id`, `employee_name`, `user` email
       - **`api_key`** and **`api_secret`** for authenticating future requests
       - `device_id` that was registered
    4. App stores API credentials in SecureStore and proceeds with authentication
  - Session validation on app startup:
    - Verifies API credentials with `/api/method/frappe.auth.get_logged_user` using Authorization header
    - **Re-validates Employee's `allow_ess` field is still enabled**
    - If credentials invalid or ESS disabled, clears auth data and logs out
  - Logout: Clears local API credentials (API keys remain valid on server until regenerated)

**Important**: When making new API calls, always include the `Authorization: token {api_key}:{api_secret}` header. Never use `credentials: 'include'`.

**Employee Self-Service (ESS) Requirement**:
- Only employees with `allow_ess = 1` in their Employee doctype can access the app
- The Employee record must have a `user_id` field linking to the Frappe user
- Employee must have an `app_password` set (separate from Frappe login password)
- **Device binding**: Employee can only login from ONE device (identified by unique device ID)
  - First login registers the device ID (generated by mobile app)
  - Subsequent logins must use the same device ID
  - Admin can reset device ID using the `reset_device_id` method
- If ESS is disabled after login, the user will be logged out on next app startup

### Frappe API Integration

**Service Layer** (`app/services/frappeService.js`):
- Provides a hook-based interface: `useFrappeService()`
- Core CRUD operations: `getList()`, `getDoc()`, `createDoc()`, `updateDoc()`, `deleteDoc()`
- API method calls: `call()` (POST), `callGet()` (GET)
- Utility methods: `getCount()`, `getMeta()`
- All methods include error handling and loading states
- **All requests automatically include `Authorization: token {api_key}:{api_secret}` header**
- API credentials are retrieved from SecureStore for each request
- Site URL is configured dynamically on first app launch

**API Pattern**:
```javascript
// Resource API (DocTypes)
GET    /api/resource/{doctype}
GET    /api/resource/{doctype}/{name}
POST   /api/resource/{doctype}
PUT    /api/resource/{doctype}/{name}
DELETE /api/resource/{doctype}/{name}

// Method API (Custom methods)
POST   /api/method/{method_name}
GET    /api/method/{method_name}
```

### Key Dependencies

- **Expo SDK 54**: Core framework for React Native development
- **React Navigation**: Stack and bottom tab navigation
- **UI Kitten**: Component library with Eva Design theming
- **React Hook Form**: Form management
- **expo-secure-store**: Secure credential storage
- **Lucide React Native**: Icon library

### File Organization

```
app/
├── (auth)/            # Authentication screens (LoginScreen, SiteSetupScreen)
├── (tabs)/            # Tab-based screens (home, updates, profile)
├── components/        # Reusable UI components (Navbar, AttendanceCalendar)
├── contexts/          # React contexts (AuthContext for auth state)
├── data/              # Constants and configuration
├── reports/           # Report screens (MonthlyAttendanceSheet)
├── screens/           # Other screens (LeaveApplication, Holidays, etc.)
└── services/          # API services (frappeService)
```

## Important Notes

### Backend Configuration
- The app uses dynamic site URL configuration (entered by user on first launch in SiteSetupScreen)
- Site URL is stored securely in SecureStore and managed by AuthContext
- Ensure CORS is properly configured on the Frappe backend for mobile app access
- **Required Employee Doctype Custom Fields**:
  - Field Name: `allow_ess`
  - Field Type: Check (Checkbox)
  - Label: "Allow Employee Self Service"
  - Description: When checked, this employee can login to the mobile app

  - Field Name: `app_password`
  - Field Type: Password
  - Label: "App Password"
  - Description: Separate password for mobile app authentication (not the Frappe login password)
  - Mandatory when `allow_ess` is checked

  - Field Name: `device_id`
  - Field Type: Data
  - Label: "Registered Device ID"
  - Description: Unique device identifier auto-captured on first login from mobile app
  - Read-only (set by backend)

  - Field Name: `device_registered_on`
  - Field Type: Datetime
  - Label: "Device Registered On"
  - Description: Date and time when the device was first registered
  - Read-only (set by backend)

- **Required Backend Method**: `mobile_app_login`
  - Custom whitelisted method for mobile app authentication
  - Handles app password verification, ESS validation, and device ID binding
  - Returns API key/secret for token-based authentication
  - See backend_mobile_auth.py for implementation details

### Platform-Specific Settings
- **Android**: Package name is `com.shubham17g.MyApp` with version code auto-increment
- **iOS**: Supports tablets
- React Native's new architecture is enabled (`newArchEnabled: true`)
- Edge-to-edge display enabled on Android

### Authentication Best Practices
- **Always** include `Authorization: token {api_key}:{api_secret}` header in API requests
- **Never** use `credentials: 'include'` - this is token-based, not session-based
- API credentials validation happens on app startup in AuthContext
- SecureStore is used to store API key and secret securely
- Use `frappeService` hook which automatically adds Authorization headers
- Handle device ID mismatch errors gracefully (inform user to contact admin)

### Common Pitfalls
1. **Don't** use session-based auth patterns - this is token-based
2. **Don't** store app passwords in SecureStore - only API credentials and user info
3. **Don't** use `credentials: 'include'` in fetch requests
4. **Do** handle API credential expiration gracefully (401 responses should trigger logout)
5. **Do** maintain consistent error handling patterns from frappeService
6. **Do** remember that device binding restricts users to one device per account
